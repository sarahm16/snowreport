const path = require('path')
const fs = require('fs')
const fsp = require('fs/promises')

const Anvil = require('../src/index')

// Local Dev
const apiKey = 'AXZj09jvHRPNBFRHMnAF2jpwOx9J5Rb6'
// Prod Mango Dev
// const apiKey = 'oBU3hec1pdBRGB5NmSJaj7QQzhiME1u8'
//
// const [eid, apiKey, jsonPath] = argv._
const baseURL = 'http://localhost:3000'

const constructorOptions = {
  apiKey,
  // cookie: 'koa:sess=c2a23c802c7c9e09016378f74ef1ee1d; koa:sess.sig=PO0AfdOUgUcsLFhFLbaz7QgGncU',
  baseURL,
  // userAgent,
  debug: true,
  keyType: 'development',
}

const client = new Anvil(constructorOptions)

function resolvePath (...bits) {
  return path.resolve(...bits)
}

function writeStream ({ data, path }) {
  return new Promise((resolve, reject) => {
    const writeStream = fs.createWriteStream(path, { encoding: null })
    data.pipe(writeStream)
    data.on('error', reject)
    writeStream.on('finish', resolve)
  })
}

function writeBuffer ({ data, path }) {
  return fsp.writeFile(path, data, { encoding: null })
}

module.exports = {
  client,
  resolvePath,
  writeStream,
  writeBuffer,
}
